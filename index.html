<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fantasy Town — Plaza</title>
  <link rel="stylesheet" href="asset/css/style.css" />
  <style>
    #hud{position:fixed;right:.75rem;bottom:.75rem;max-width:60vw;max-height:40vh;overflow:auto;font:12px/1.35 ui-monospace,Menlo,monospace;background:rgba(0,0,0,.65);color:#eaeaff;padding:.6rem .7rem;border:1px solid rgba(255,255,255,.18);border-radius:.5rem;backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);z-index:9999}
    #hud b{color:#a5d6ff} #hud .ok{color:#7dff9b} #hud .err{color:#ff8aa5}
    html,body{height:100%} #scene{display:block;width:100vw;height:100vh;background:transparent}
  </style>
</head>
<body>
  <canvas id="scene"></canvas>
  <div id="hud">Booting…</div>

  <script type="module" crossorigin>
    const hud = document.getElementById('hud');
    const log = (m,c="")=>{const p=document.createElement('div');if(c)p.className=c;p.innerHTML=m;hud.appendChild(p);hud.scrollTop=hud.scrollHeight;console.log(m.replace(/<[^>]+>/g,""));};

    // Safari-friendly CDN
    const CDN = {
      three: "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js",
      orbit: "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/controls/OrbitControls.js",
      gltf:  "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/loaders/GLTFLoader.js",
      vrm:   "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@2.0.7/lib/three-vrm.module.js"
    };

    let THREE, OrbitControls, GLTFLoader, VRM, VRMUtils;
    try {
      THREE = await import(CDN.three);
      ({ OrbitControls } = await import(CDN.orbit));
      ({ GLTFLoader } = await import(CDN.gltf));
      ({ VRM, VRMUtils } = await import(CDN.vrm));
      log(`✅ <b>Imports OK</b> — three@0.152.2 / three-vrm@2.0.7`,"ok");
    } catch(e){ log(`❌ <b>Import failed</b>: ${e?.message||e}`,"err"); throw e; }

    const canvas = document.getElementById('scene');
    const renderer = new THREE.WebGLRenderer({canvas,antialias:true,alpha:true});
    renderer.setPixelRatio(Math.min(devicePixelRatio,2));
    renderer.setSize(innerWidth,innerHeight);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(40, innerWidth/innerHeight, .1, 1000);
    camera.position.set(0,1.5,6);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.target.set(0,1.4,0); controls.enableDamping = true;

    scene.add(new THREE.HemisphereLight(0xffffff,0x444466,0.7));
    const dir = new THREE.DirectionalLight(0xffffff,0.9); dir.position.set(3,5,2); scene.add(dir);
    const ground = new THREE.Mesh(new THREE.CircleGeometry(6,64),
      new THREE.MeshStandardMaterial({color:0x1a1a1f,metalness:.05,roughness:.95}));
    ground.rotation.x = -Math.PI/2; ground.receiveShadow = true; scene.add(ground);

    const loader = new GLTFLoader();
    const localNames = ["stella","tracy","alexandria","jem","carol","nina","charlotte","abbey","billie","odessa","sorcha","themis","clarice","whitestar","reyczar"];
    const vrms = [];

    const place = ()=>{const r=3.3,y=0;vrms.forEach((v,i)=>{const t=(i/Math.max(1,vrms.length))*Math.PI*2;v.scene.position.set(Math.cos(t)*r,y,Math.sin(t)*r);v.scene.lookAt(0,1.4,0);});};
    const loadVRM = (url)=>new Promise((res,rej)=>{
      loader.load(url,(gltf)=>{
        VRM.from(gltf).then(vrm=>{
          VRMUtils.removeUnnecessaryJoints(vrm.scene);
          vrm.scene.traverse(o=>{ if(o.isMesh){ o.frustumCulled=false;o.castShadow=true;o.receiveShadow=true; }});
          scene.add(vrm.scene); vrms.push(vrm); place(); res(vrm);
        }).catch(rej);
      },undefined,(err)=>rej(err));
    });

    // 1) Try local files
    log(`<b>Models folder:</b> castle-town/asset/models/`);
    let loadedAny = false;
    for (const n of localNames) {
      const url = `asset/models/${n}.vrm`;
      try {
        const head = await fetch(url, { method:"HEAD", cache:"no-store" });
        if (!head.ok) { log(`↳ (missing) <code>${url}</code> — HTTP ${head.status}`); continue; }
        await loadVRM(url);
        log(`✅ <span class="ok">Loaded</span> <code>${n}.vrm</code>`,"ok");
        loadedAny = true;
      } catch(e){ log(`❌ <span class="err">Failed</span> <code>${url}</code> — ${e?.message||e}`,"err"); }
    }

    // 2) If none loaded, pull a tiny public sample VRM so the scene works now
    if (!loadedAny) {
      const sample = "https://pixiv.github.io/three-vrm/examples/models/VRM/AliciaSolid.vrm";
      log(`<b>No local VRMs found.</b> Loading sample: <code>${sample}</code>`);
      try { await loadVRM(sample); log(`✅ <span class="ok">Sample VRM loaded</span>`,"ok"); }
      catch(e){ log(`❌ <span class="err">Sample failed</span> — ${e?.message||e}`,"err"); }
    }

    addEventListener('resize', ()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); });
    (function animate(){ controls.update(); renderer.render(scene,camera); requestAnimationFrame(animate); })();
  </script>
</body>
</html>
